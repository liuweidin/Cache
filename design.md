# Cache 设计
## Cache简介
状态机实现的阻塞式二路组相联Cache，大小为8KB，在写回法中，采用LRU替换策略，每个cache行有8个32bit数据，同时该项目中的cache适用于顺序双发射CPU，能够同时取出两条指令，在其他的项目中可能会出现意想不到的错误。

注：还有一点需要说明的是，本人的cache设计思路借鉴了UItraMIPS_NSCSCC项目中的cache设计思路（https://github.com/SocialistDalao/UltraMIPS_NSCSCC）与（胡伟武. CPU设计实战. 机械工业出版社）

## 地址编码

地址切分情况：
| Tag    | group_addr |  Offset |  
| ----------- | ----------- |   ----------- | 
| 31:12     | 11:5       |  4:0       | 

**Offset（组内偏移）** 用于标识出要读写的数据具体在一路cache中的哪一个字节。本设计中，一路cache行存储8个32位数据，也就是一共有32个字节，对应于5位的偏移地址。

**group_addr（组地址）** 对于内存地址来说，应该被映射到cache的哪一个组，该部分也指示出了cache内一共有多少组。

**Tag（标签）** 用于标识数据存储在组内的哪一路cache中。


## 标志寄存器

**Valid位** ：用于标识数据是否有效。

**Dirty位（写回法中使用）** ：用于标识数据是否被修改过还未写回主存。

**LRU位（最近最少用标志）** ：用于标志替换时应该将哪一路数据替换出Cache。

上述标志位采用FPGA片内的分布式RAM实现。

## Cache块的组织
| bank0|bank1|bank2|bank3|bank4|bank5|bank6|bank7|
|------|-----|-----|-----|-----|-----|-----|-----|
| 32bit|32bit|32bit|32bit|32bit|32bit|32bit|32bit|

所有Cache行采用Block Ram 实现。

## 写回法

**主存写策略**

1. Cache命中时，当Cache中写入数据时，不直接同步更新内存中的数据，而是在cache中标记更新的块为 **”脏“** 。等该块被替换出Cache时，才将其写回内存中。
2. Cache未命中时，将目标数据读入Cache并且修改，标记为 **”脏“** 。  

**Cache数据替换策略**

对于2路组相联来说，每一组都设置了一位LRU位标志，0表示way0最近没有使用，为1同理。如果被替换的块是 **”脏“** ，那么还需要将数据写回内存。

当命中时需要将LRU标志位设置为对应的标志，即命中way0时设置为1表示最近way1未被使用；命中way1同理。

## 写直达法
写直达法在Cache数据替换策略上与写回法是一致的，不同的是主存写策略。

**主存写策略**

1. Cache命中时，当Cache中写入数据时，同时将数据写入内存中。
2. Cache未命中时，将目标数据读入Cache并且修改，再写回内存中 。 

## 两种方法的选择
从效率上来说，写回法更具有优势，但是写回法存在一个问题，就是内存与cache中的数据存在着不一致的问题，这种不一致在发生cache数据替换时才解决；而写直达法不存在不一致问题。

## cache状态机设计
1. Look_UP： 根据group_addr读取组内两路的tag与cache行。
2. Scanf_cache： 比较两路的tag，如果 **读命中** 则输出数据，转Look_Up；如果 **写命中** 则将修改好的数据写入cache，之后进入Look_UP。**写回法中**，如果替换的不是脏块，**读写未命中** 都转到Miss_hit，如果是脏块，则转Write_ram，将数据写回内存。***写直达法** 中读写未命中转 Miss_hit
3. Write_ram： 写回法中发生替换时将 **“脏”** 块写回内存。转Write_data；写直达法中当需要写数据时都需要将数据写回内存转Look_UP。
4. Miss_hit： 根据LRU选择出替换出cache的块，同时开始内存读，在写回法中转Write_data; 写直达法中转Write_data；
5. Write_data： 将从内存中读出的数据写入cache行中。在写回法中，转Look_UP，写未命中时设置脏位; 在写直达中，如果是写未命中时，同时还要将数据写回内存，转Write_ram，读未命中转 Look_UP。
